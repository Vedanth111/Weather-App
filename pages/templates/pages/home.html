{% extends "base.html" %}

{% block page_content %}
{% load static %}

<!-- App Title -->
<div class="appname"> WEATHER APP </div>

<!-- Error display box -->
<div id="errorDisplay" style="color: red; margin: 10px 0;"></div>

<!-- Search bar for city input -->
<div class="searchcity">
  <form>
    <label for="fname"> Search For A City Name:</label>
    <input type="text" id="cityname" name="cityname">
    <input type="submit" value="Submit">
    <div class="hideerror" id="errormessage"><span>City Name is required</span></div>
  </form>
</div>


<!-- Weather App Script -->
<script class="scriptstyle">
  $(document).ready(function () {
    const errorDiv = $("#errorDisplay");
    const video = $("#weatherVideo")[0];
    const STATIC_URL = "{% static 'images/' %}";  // ✅ fixed

    /* -------------------------
       Error Handling Functions
       ------------------------- */
    function showErrorMessage(message) {
      errorDiv.text(message);
    }

    function clearErrorMessage() {
      errorDiv.text("");
    }

    /* -------------------------
       Update Background Video 
       based on weather condition
       ------------------------- */
    function updateVideo(condition) {
      let videoName = "clear.mp4"; 

      switch (condition.toLowerCase()) {
        case "clear": videoName = "clear.mp4"; break;
        case "clouds": videoName = "clouds.mp4"; break;
        case "rain": videoName = "rain.mp4"; break;
        case "drizzle": videoName = "drizzle.mp4"; break;
        case "thunderstorm": videoName = "thunderstorm.mp4"; break;
        case "snow": videoName = "snow.mp4"; break;
        case "mist":
        case "smoke":
        case "haze":
        case "dust":
        case "fog":
        case "sand":
        case "ash":
        case "squall":
        case "tornado":
          videoName = "mist.mp4"; break;
        default:
          videoName = "clear.mp4";
      }

      // Dynamically set new video source
      const newSrc = STATIC_URL + videoName + "?v=" + new Date().getTime();
      console.log("Setting video source to:", newSrc);

      const sourceElement = $("#weatherVideo source")[0];  
      sourceElement.src = newSrc;

      // Reload and play video
      video.load(); 
      video.play().catch(err => console.warn("Autoplay failed:", err));
    }

    /* -------------------------
       Update UI with Weather Data
       ------------------------- */
    function updateUI(data) {
      clearErrorMessage();

      // Update top display values
      $("#updatedname").text(data.name);
      $("#cityname").val(data.name);
      $("#temperature").text(`High:${Math.round(data.main.temp_max)}°C Low:${Math.round(data.main.temp_min)}°C`);
      $("#temperatureactual").text(`${Math.round(data.main.temp)}°C`);
      $("#temptext").text(`Temp`);

      // Capitalize weather description
      const description = data.weather[0].description
        .split(" ")
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
      $("#description").text(description);

      // Modal title
      $("#ModalLabel").text(`The Weather in ${data.name}`);

      // Convert sunrise/sunset to local times
      const timezoneOffset = data.timezone || 0;
      const sunriseDate = new Date((data.sys.sunrise + timezoneOffset) * 1000);
      const sunsetDate = new Date((data.sys.sunset + timezoneOffset) * 1000);
      const timeOptions = { hour: '2-digit', minute: '2-digit' };
      const sunriseLocal = sunriseDate.toLocaleTimeString([], timeOptions);
      const sunsetLocal = sunsetDate.toLocaleTimeString([], timeOptions);

      // Fill modal body with weather info
      $(".modal-body").html(`
        <div class="d-flex flex-wrap gap-3 justify-content-between">

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>City:</strong><br>${data.name}, ${data.sys.country}
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Condition:</strong><br>${description}
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Temperature:</strong><br>
            Actual: ${Math.round(data.main.temp)}°C<br>
            Feels Like: ${Math.round(data.main.feels_like)}°C
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>High / Low:</strong><br>
            High: ${Math.round(data.main.temp_max)}°C<br>
            Low: ${Math.round(data.main.temp_min)}°C
          </div>
          
          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Humidity & Pressure:</strong><br>
            Humidity: ${data.main.humidity}%<br>
            Pressure: ${data.main.pressure} hPa
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Sunrise & Sunset:</strong><br>
            Sunrise: ${sunriseLocal}<br>
            Sunset: ${sunsetLocal}
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Cloud Coverage:</strong><br>${data.clouds.all}%
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Visibility:</strong><br>${data.visibility} meters
          </div>

          <div class="p-3 border rounded shadow-sm flex-fill text-center">
            <strong>Wind:</strong><br>
            Speed: ${data.wind.speed} m/s<br>
            Direction: ${data.wind.deg}°<br>
            <div class="wind-clock-compass mt-2">
              <div class="direction-label north">N</div>
              <div class="direction-label east">E</div>
              <div class="direction-label south">S</div>
              <div class="direction-label west">W</div>

              <!-- Rotating arrow shows wind direction -->
              <div class="compass-arrow-container" style="transform: rotate(${data.wind.deg}deg);">
                <div class="compass-arrow-head"></div>
                <div class="compass-arrow-line"></div>
              </div>

              <div class="center-dot"></div>
            </div>
          </div>

        </div>
      `);

      // Update background video
      updateVideo(data.weather[0].main);
    }

    /* -------------------------
       Fetch Weather from Backend
       ------------------------- */
    function fetchWeatherFromBackend(params) {
      $.ajax({
        type: "GET",
        url: "/getweather/",
        data: params,
        dataType: "json",
        success: function (data) {
          console.log(data);
          if (data.error) {
            showErrorMessage(data.error);
            return;
          }
          updateUI(data);
        },
        error: function () {
          showErrorMessage("Error Fetching Weather or Invalid Location.");
        }
      });
    }

    /* -------------------------
       Try Geolocation First
       ------------------------- */
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          fetchWeatherFromBackend({ lat: position.coords.latitude, lon: position.coords.longitude });
          console.log(position.coords.latitude)
          console.log(position.coords.longitude)
        },
        error => {
          showErrorMessage(`Geolocation error (${error.code}): ${error.message}`);
        }
      );
    } else {
      showErrorMessage("Geolocation is not supported by this browser.");
    }

    /* -------------------------
       Handle City Search Form
       ------------------------- */
    $("form").submit(function (event) {
      event.preventDefault();
      const cityInput = $("#cityname").val().trim();

      if (cityInput === "") {
        $("#cityname").addClass("error");
        $("#errormessage").removeClass("hideerror");
        showErrorMessage("Please enter a city name.");
        return;
      }

      $("#cityname").removeClass("error");
      $("#errormessage").addClass("hideerror");
      clearErrorMessage();

      fetchWeatherFromBackend({ name: cityInput });
    });
  });
</script>


<!-- Main Weather Display -->
<div class="container position-relative box">
  <div class="city position-relative">

    <!-- Background video -->
    <video autoplay muted loop id="weatherVideo" class="background-video" playsinline>
      <source src="{% static 'images/clear.mp4' %}" type="video/mp4">
      Your browser does not support the video tag.
    </video>

    <!-- Overlay weather info -->
    <div class="layer">
      <div class="top-left" id="updatedname">{{ weather.name }}</div>
      <div class="top-right" id="temperature">H:{{ weather.main.temp_max }}°C L:{{ weather.main.temp_min }}°C</div>
      <div class="centered" id="temperatureactual">{{ weather.main.temp }}°C</div>
      <div class="centered" id="temptext">Temp</div>
      <div class="center-top" id="description">{{ weather.weather.0.description }}</div>
    </div>

    <!-- Transparent layer that opens modal on click -->
    <div
      data-bs-toggle="modal"
      data-bs-target="#Modal"
      style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 10;
      "
    ></div>

  </div>
</div>


<!-- Modal for detailed weather info -->
<div class="modal fade" id="Modal" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h1 class="modal-title fs-5" id="ModalLabel">The Weather in {{weather.name}}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Weather info filled dynamically by JS -->
      <div class="modal-body">
        {{ weather.name }}
      </div>

      <div class="modal-footer">
        <!-- You can add buttons here if needed -->
      </div>
    </div>
  </div>
</div>
{% endblock page_content %}
